name: buildx

on:
  push:
    branches:
      - 'main'
      - 'development'
      - 'staging'

jobs:
  docker:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    steps:
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Setup docker context for buildx
        id: buildx-context
        run: docker context create builders || docker context use builders

      - name: Extract repository name
        id: extract_repo_name
        run: |
          repo_url=${{ github.repository }}
          repo_name=$(basename $repo_url)
          echo "REPO_NAME=${repo_name}" >> $GITHUB_ENV
          echo "REPO_NAME=${repo_name}"

      - name: set lower case owner name
        run: |
          echo "REPO_LC=${OWNER,,}" >>${GITHUB_ENV}
        env:
          OWNER: '${{ env.REPO_NAME }}'

          #- name: set vars per branch
          #  env:
          #    REACT_APP_ALCHEMY_API_KEY: "${{ secrets.REACT_APP_ALCHEMY_API_KEY }}"
          #    REACT_APP_WEB3_MODAL_PROJECT_ID: "${{ secrets.REACT_APP_WEB3_MODAL_PROJECT_ID }}"
          #    REACT_APP_BEE_URL: "${{ vars.REACT_APP_BEE_URL }}"
          #    REACT_APP_BEE_DEBUG_URL: "${{ vars.REACT_APP_BEE_DEBUG_URL }}"
          #    REACT_APP_FAIROS_URL: "${{ vars.REACT_APP_FAIROS_URL }}"
          #    REACT_APP_BLOCKCHAIN_INFO: "${{ vars.REACT_APP_BLOCKCHAIN_INFO }}"
          #    REACT_APP_ENVIRONMENT: "${{ vars.REACT_APP_ENVIRONMENT }}"
          #    REACT_APP_INVITE_URL: "${{ vars.REACT_APP_INVITE_URL: }}"
          #  id: vars
      - name: copy ca
        run: |
          sudo mkdir -p /etc/docker/certs.d/${{ secrets.REGISTRY_URL }}
          echo "${{ secrets.REGISTRY_CA }}" | sudo tee /etc/docker/certs.d/${{ secrets.REGISTRY_URL }}/ca.crt

      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          endpoint: builders
          config-inline: |
            [registry."${{ secrets.REGISTRY_URL }}"]
              http = false
              insecure = false
              ca=["/etc/docker/certs.d/${{ secrets.REGISTRY_URL }}/ca.crt"]

      -
        name: Build and push
        uses: docker/build-push-action@v4
        with:
          push: true
          platforms: |
            linux/amd64
          build-args: |
            "REACT_APP_ALCHEMY_API_KEY=${{ secrets.REACT_APP_ALCHEMY_API_KEY }}"
            "REACT_APP_WEB3_MODAL_PROJECT_ID=${{ secrets.REACT_APP_WEB3_MODAL_PROJECT_ID }}"
            "REACT_APP_BEE_URL=${{ vars.REACT_APP_BEE_URL }}"
            "REACT_APP_BEE_DEBUG_URL=${{ vars.REACT_APP_BEE_DEBUG_URL }}"
            "REACT_APP_FAIROS_URL=${{ vars.REACT_APP_FAIROS_URL }}"
            "REACT_APP_BLOCKCHAIN_INFO=${{ vars.REACT_APP_BLOCKCHAIN_INFO }}"
            "REACT_APP_ENVIRONMENT=${{ vars.REACT_APP_ENVIRONMENT }}"
            "REACT_APP_INVITE_URL=${{ vars.REACT_APP_INVITE_URL }}"
          tags: ${{ secrets.REGISTRY_URL }}/${{ env.REPO_LC }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.REGISTRY_URL }}/${{ env.REPO_LC }}:buildcache
          cache-to: type=registry,ref=${{ secrets.REGISTRY_URL }}/${{ env.REPO_LC }}:buildcache,mode=max
